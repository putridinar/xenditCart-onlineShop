<div class="product-grid" id="productGrid">
  <div class="loading">Memuat produk...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "{{ site.api_key }}",
  authDomain: "{{ site.auth_domain }}",
  projectId: "{{ site.project_id }}",
  storageBucket: "{{ site.storage_bucket }}",
  messagingSenderId: "{{ site.sender_id }}",
  appId: "{{ site.app_id }}",
  measurementId: "{{ site.measure_id }}"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function generateStars(total, count) {
  const avg = count > 0 ? total / count : 0;
  let stars = '';
  for (let i = 1; i <= 5; i++) {
    stars += `<i class="bi ${i <= avg ? 'bi-star-fill text-warning' : 'bi-star text-muted'}"></i>`;
  }
  return stars;
}

// Fetch & Render Produk
async function fetchAndRenderProducts() {
  const grid = document.getElementById("productGrid");

  try {
    const querySnapshot = await getDocs(collection(db, "products"));
    grid.innerHTML = ""; // Hapus loading

    if (querySnapshot.empty) {
      grid.innerHTML = "<p class='loading'>Produk belum tersedia.</p>";
      return;
    }

    querySnapshot.forEach(doc => {
      const data = doc.data();
      grid.innerHTML += `
		<div class="card position-relative shadow-sm border-0 rounded-4 overflow-hidden">
		  <!-- Tombol Favorit di pojok atas -->
		  <button id="likeButton" class="btn btn-light position-absolute top-0 end-0 m-2 shadow-sm rounded-circle like-btn" style="z-index: 10;">
			<i class="bi bi-heart"></i>
		  </button>

		  <!-- Gambar Produk -->
		  <img class="card-img-top" src="${data.image}" alt="${data.name}" style="object-fit: cover; height: 250px;">

		  <!-- Isi Card -->
		  <div class="card-body text-center">
			<h5 class="card-title fw-semibold mb-1">${data.name}</h5>
			<p class="text-primary fw-bold">Rp ${data.price.toLocaleString('id-ID')}</p>

			<!-- Rating -->
			<div class="mb-2">
			  ${generateStars(data.ratingTotal, data.ratingCount)}
			</div>

			<a href="/product?id=${doc.id}" class="btn btn-outline-dark w-100 rounded-pill">Lihat Produk</a>
		  </div>
		</div>
      `;
    });

async function checkLikedStatus() {
  if (!currentUser) return;
  const likeRef = doc(db, `likes/${currentUser.uid}/products/${id}`);
  const likeSnap = await getDoc(likeRef);
  setLikedUI(likeSnap.exists());
}

function setLikedUI(isLiked) {
  const likeButton = document.getElementById('likeButton');
  const icon = likeButton.querySelector('i');
  likeButton.classList.toggle('btn-outline-danger', isLiked);
  likeButton.classList.toggle('btn-danger', !isLiked);
  if (isLiked) {
    icon.classList.replace('bi-heart', 'bi-heart-fill');
  } else {
    icon.classList.replace('bi-heart-fill', 'bi-heart');
  }
}
  } catch (error) {
    grid.innerHTML = `<p class='loading'>Gagal memuat produk: ${error.message}</p>`;
  }
}

fetchAndRenderProducts();
</script>
