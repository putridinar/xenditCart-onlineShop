<!-- Modal Profile User -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="profileForm">
        <div class="modal-header">
          <h5 class="modal-title" id="profileModalLabel">Profile Saya</h5>
        </div>
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Nama</label>
            <input type="text" id="profileName" class="form-control" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="profileEmail" class="form-control" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">Alamat Pengiriman</label>
            <textarea id="profileAddress" class="form-control" rows="3"></textarea>
          </div>

          <div id="profileStatus" class="text-center"></div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDN2dgu-Sdsc9K5fermxPFwDUiCzX71ce8",
  authDomain: "tokoputridinar.firebaseapp.com",
  projectId: "tokoputridinar",
  storageBucket: "tokoputridinar.firebasestorage.app",
  messagingSenderId: "747234240117",
  appId: "1:747234240117:web:a87af4f6724ab87ad23a3c",
  measurementId: "G-M2JGJH3NVQ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const profilePic = document.getElementById('profilePic');
const profileName = document.getElementById('profileName');
const profileEmail = document.getElementById('profileEmail');
const profileAddress = document.getElementById('profileAddress');
const profileStatus = document.getElementById('profileStatus');

// Cek login
onAuthStateChanged(auth, async (user) => {
  if (user) {
    profileEmail.value = user.email;
    profileName.value = user.displayName || "Nama Tidak Tersedia";
    profilePic.src = user.photoURL || 'https://ionicframework.com/docs/img/demos/avatar.svg';

    // Load alamat dari Firestore
    const docRef = doc(db, "users", user.uid);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      const data = docSnap.data();
      profileAddress.value = data.address || "";
    }
  }
});

// Update Alamat
const profileForm = document.getElementById('profileForm');

profileForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const user = auth.currentUser;
  if (!user) return;

  try {
    await setDoc(doc(db, "users", user.uid), {
      address: profileAddress.value.trim()
    }, { merge: true });

    profileStatus.innerHTML = `<div class="text-success">✅ Alamat berhasil diperbarui!</div>`;
    setTimeout(() => {
      profileStatus.innerHTML = "";
      bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
    }, 1500);

  } catch (error) {
    console.error(error);
    profileStatus.innerHTML = `<div class="text-danger">❌ Gagal update: ${error.message}</div>`;
  }
});
</script>