<header class="header bg-white shadow-sm mb-4">
	<nav class="navbar navbar-expand-lg navbar-light fixed-top navbar-blur shadow-sm">
	  <div class="container">
	  <div class="d-flex">
	<!-- Tambahan di Navbar -->
	<div class="dropdown" id="dropProfile" style="display:none;">
	  <button class="btn btn-light border-0 p-0" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
		<img id="profilePic" src="https://ionicframework.com/docs/img/demos/avatar.svg" alt="Profile" class="rounded-circle" style="width:40px; height:40px; object-fit:cover; border:2px solid #ccc;">
	  </button>
	  <ul class="dropdown-menu dropdown-menu-start" aria-labelledby="userMenu">
		<li><button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#profileModal">Profile Saya</button></li>
		<li><hr class="dropdown-divider"></li>
		<li><button class="dropdown-item text-danger" id="logoutBtn">Logout</button></li>
	  </ul>
	</div>
			<a class="navbar-brand fw-bold ms-2" href="{{ site.baseurl }}/">{{ site.title }}</a>
	</div>
	  <div class="d-flex">
			<button class="btn btn-dark d-lg-none btn-round position-relative" data-bs-toggle="offcanvas" data-bs-target="#cartCanvas">
			  <i class="bi bi-cart"></i>
			  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartCount">0</span>
			</button>
		<button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar">
		  <span class="navbar-toggler-icon"></span>
		</button>
		</div>

		<!-- Desktop Menu -->
		<div class="collapse navbar-collapse">
		  <ul class="navbar-nav mx-auto">
			<li class="nav-item"><a class="nav-link" href="/">Beranda</a></li>
			<li class="nav-item"><a class="nav-link" href="/allProduct">Produk</a></li>
			<li class="nav-item"><a class="nav-link" href="/promo">Promo</a></li>
		  </ul>
		  <div class="d-flex gap-2">
			<a href="/userLogin" id="log-in" class="btn btn-light btn-round" style="display:none"><i class="bi bi-person"></i></a>
			<button class="btn btn-dark btn-round position-relative" data-bs-toggle="offcanvas" data-bs-target="#cartCanvas">
			  <i class="bi bi-cart"></i>
			  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartCount">0</span>
			</button>
		  </div>
		</div>
	  </div>
	</nav>
	<!-- OFFCANVAS NAVBAR (Mobile Menu) -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Menu</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" href="/">Beranda</a></li>
      <li class="nav-item"><a class="nav-link" href="/allProduct">Produk</a></li>
      <li class="nav-item"><a class="nav-link" href="/promo">Promo</a></li>
      <li class="nav-item"><a class="nav-link" href="/userLogin">Login</a></li>
    </ul>
  </div>
</div>
</header>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #19303833;
  }

  .navbar-blur {
    backdrop-filter: blur(10px);
    background-color: rgba(255, 255, 255, 0.8);
    transition: all 0.3s ease;
  }

  .btn-round {
    border-radius: 50px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    transition: 0.3s ease;
  }

  .btn-round:hover {
    box-shadow: 0 0 15px rgba(0,0,0,0.15);
  }

  .dropdown-menu {
    border-radius: 1rem;
    padding: 1rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  }
  
@keyframes shake {
  0% { transform: translate(0px, 0px) rotate(0deg); }
  20% { transform: translate(-2px, 2px) rotate(-2deg); }
  40% { transform: translate(-2px, -2px) rotate(2deg); }
  60% { transform: translate(2px, 2px) rotate(-2deg); }
  80% { transform: translate(2px, -2px) rotate(2deg); }
  100% { transform: translate(0px, 0px) rotate(0deg); }
}

.shake {
  animation: shake 0.5s;
}
</style>
<!-- Offcanvas Keranjang -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartCanvas" aria-labelledby="cartOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="cartOffcanvasLabel">Keranjang Belanja</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column">
    <div id="cartItems" class="flex-grow-1 overflow-auto">
      <!-- List produk akan muncul disini -->
    </div>
	<div class="mt-3" id="checkoutSection" style="display:none;">
	  <h5 class="d-flex justify-content-between">
		<span>Total:</span>
		<span id="cartTotal">Rp 0</span>
	  </h5>
	  <button class="btn btn-primary w-100 mt-3" onclick="goCheckout()">Checkout</button>
	</div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, collection, getDocs, deleteDoc, doc, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "{{site.api_key}}",
    authDomain: "{{site.auth_domain}}",
    projectId: "{{site.project_id}}",
    storageBucket: "{{site.storage_bucket}}",
    messagingSenderId: "{{site.sender_id}}",
    appId: "{{site.app_id}}",
    measurementId: "{{site.measure_id}}"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const logoutBtn = document.getElementById('logoutBtn');
const dropProfile = document.getElementById('dropProfile');

logoutBtn.addEventListener('click', () => {
  signOut(auth)
    .then(() => {
      showGlobalAlert("Logout berhasil! üëã");
      window.location.href = "/";
    })
    .catch((error) => {
      console.error(error);
      showGlobalAlert("‚ùå Gagal logout: " + error.message);
    });
});

let currentUser = null;

// üî• Cek user login
onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    checkoutSection.style.display = 'block'; // üî• TAMPILKAN
    dropProfile.style.display = "inline-block";
    renderCart();
	
      // üñº Gambar profil dari Google
      const img = document.getElementById('profilePic');
      img.src = user.photoURL || "https://ionicframework.com/docs/img/demos/avatar.svg";
  } else {
    currentUser = null;
    checkoutSection.style.display = 'none'; // üî• SEMBUNYIKAN
    dropProfile.style.display = "none";
  }
});
	  
	  
function showCartToast(message = "Keranjang diperbarui!") {
  const toastEl = document.getElementById('cartToast');
  const toastMsg = document.getElementById('cartToastMessage');
  
  toastMsg.innerText = message;
  
  const toast = new bootstrap.Toast(toastEl);
  toast.show();
}

async function renderCart() {
  if (!currentUser) return; // Cek login

  const cartItemsEl = document.getElementById('cartItems');
  const cartCountMobile = document.getElementById('cartCountMobile');
  const cartCountDesktop = document.getElementById('cartCountDesktop');
  const cartTotalEl = document.getElementById('cartTotal');
  const checkoutSection = document.getElementById('checkoutSection');

  try {
    const cartRef = collection(db, `carts/${currentUser.uid}/items`);
    const snapshot = await getDocs(cartRef);

    let cartHTML = '';
    let totalItems = 0;
    let totalPrice = 0;

    snapshot.forEach(docSnap => {
      const item = docSnap.data();
      const itemId = docSnap.id;

      totalItems += item.quantity;
      totalPrice += item.price * item.quantity;

      cartHTML += `
		<div class="cart-item d-flex align-items-start gap-3 p-3 mb-3 shadow-sm rounded-4 bg-white position-relative">
		  <img src="${item.image}" alt="${item.name}" class="rounded-3" style="width: 90px; height: 90px; object-fit: cover;">

		  <div class="flex-grow-1">
			<h6 class="mb-1 fw-semibold text-dark">${item.name}</h6>
			<div class="text-muted small mb-1">
			  <span>Warna: ${item.color || '-'}</span> | 
			  <span>Ukuran: ${item.size || '-'}</span>
			</div>
			<div class="small text-muted mb-1">Jumlah: ${item.quantity}</div>
			<div class="fw-bold text-primary">Rp ${(item.price * item.quantity).toLocaleString('id-ID')}</div>
		  </div>

		  <button class="btn btn-sm btn-light border-0 rounded-circle shadow-sm text-danger position-absolute top-0 end-0 m-2" onclick="removeCartItem('${itemId}')">
			<i class="bi bi-x-lg"></i>
		  </button>
		</div>

      `;
    });

    // üõí Render ke DOM
    cartItemsEl.innerHTML = snapshot.empty
      ? `<p class="text-center text-muted">Keranjang kosong.</p>`
      : cartHTML;

    // üî• Update Cart Counter
    if (cartCountMobile) cartCountMobile.innerText = totalItems;
    if (cartCountDesktop) cartCountDesktop.innerText = totalItems;

    // üî• Update Cart Total
    if (cartTotalEl) cartTotalEl.innerText = "Rp " + totalPrice.toLocaleString('id-ID');

    // üî• Tampilkan / Sembunyikan Checkout Section
    if (checkoutSection) {
      if (snapshot.empty) {
        checkoutSection.style.display = "none";
      } else {
        checkoutSection.style.display = "block";
      }
    }

  } catch (error) {
    console.error('Error load cart:', error);
    if (cartItemsEl) cartItemsEl.innerHTML = `<p class="text-danger">Gagal memuat keranjang.</p>`;
  }
}

// Fungsi hapus item dari keranjang
window.removeCartItem = async function(itemId) {
  if (!currentUser) return;

  try {
    await deleteDoc(doc(db, `carts/${currentUser.uid}/items/${itemId}`));
    showCartToast("üóëÔ∏è Item dihapus dari keranjang!");
    renderCart(); // Refresh setelah hapus
  } catch (error) {
    console.error('Error hapus item:', error);
    showCartToast("‚ùå Gagal hapus item!", "danger");
  }
}

// üî• Saat buka cart offcanvas, auto refresh isi keranjang
const cartOffcanvas = document.getElementById('cartCanvas');
if (cartOffcanvas) {
  cartOffcanvas.addEventListener('show.bs.offcanvas', function () {
    renderCart();
  });
}
</script>
<script>
function goCheckout() {
  window.location.href = "/checkout";
}
</script>
<style>
.cart-item {
  transition: box-shadow 0.3s ease, transform 0.2s ease;
}
.cart-item:hover {
  box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}
</style>
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="cartToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="cartToastMessage">
        Keranjang diperbarui.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
