---
permalink: /success
---
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Terima Kasih - Pesanan Anda Terkonfirmasi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .spinner {
      width: 80px;
      height: 80px;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #0d6efd;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 30px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="d-flex flex-column justify-content-center align-items-center vh-100">

  <div id="statusBox" class="text-center">
    <div id="loading">
      <div class="spinner"></div>
      <h5>Mengirim konfirmasi ke admin...</h5>
    </div>
    <div id="success" style="display:none;">
      <h1 class="text-success mb-3">âœ… Terima Kasih!</h1>
      <p>Pesanan kamu berhasil dikirim ke admin.</p>
      <a href="/" class="btn btn-primary mt-3">Kembali ke Beranda</a>
    </div>
    <div id="failed" style="display:none;">
      <h1 class="text-danger mb-3">âŒ Gagal Kirim!</h1>
      <p>Mohon periksa koneksi atau hubungi admin manual.</p>
      <a href="/" class="btn btn-secondary mt-3">Coba Lagi</a>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDocs, collection, doc, getDoc, deleteDoc, getFirestore } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDN2dgu-Sdsc9K5fermxPFwDUiCzX71ce8",
  authDomain: "tokoputridinar.firebaseapp.com",
  projectId: "tokoputridinar",
  storageBucket: "tokoputridinar.firebasestorage.app",
  messagingSenderId: "747234240117",
  appId: "1:747234240117:web:a87af4f6724ab87ad23a3c",
  measurementId: "G-M2JGJH3NVQ"
};

const app = initializeApp(firebaseConfig);

const db = getFirestore();
const auth = getAuth();

async function sendTelegramOrder() {
  const loading = document.getElementById('loading');
  const success = document.getElementById('success');
  const failed = document.getElementById('failed');

  loading.style.display = 'block';
  success.style.display = 'none';
  failed.style.display = 'none';

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "/userLogin"; // kalau belum login
      return;
    }

    try {
      // ğŸ”¥ Ambil data pembeli dari users/{uid}
      const buyerSnap = await getDoc(doc(db, "users", user.uid));
      if (!buyerSnap.exists()) {
        alert("âŒ Data user belum lengkap. Silakan isi alamat terlebih dahulu.");
        window.location.href = "/checkout";
        return;
      }
      const buyer = buyerSnap.data();

      // ğŸ”¥ Ambil cart items dari carts/{uid}/items
      const cartRef = collection(db, `carts/${user.uid}/items`);
      const cartSnap = await getDocs(cartRef);

      if (cartSnap.empty) {
        window.location.href = "/";
        return;
      }

		let totalHarga = 0;
		let fullName = `${buyer.firstName || ''} ${buyer.lastName || ''}`.trim();
		let alamat = `${buyer.address?.street || ''}, ${buyer.address?.city || ''}, ${buyer.address?.postalCode || ''}, ${buyer.address?.province || ''}, ${buyer.address?.country || ''}`;
		let kurir = `${buyer.shippingType || ''}`;

		// Bikin pesan
		let pesan = `ğŸ›’ <b>Konfirmasi Pesanan Baru</b>\n\n`;
		pesan += `ğŸ‘¤ <b>Nama:</b> ${fullName}\n`;
		pesan += `ğŸ“ <b>Telepon:</b> ${buyer.phone || '-' }\n`;
		pesan += `ğŸ  <b>Alamat:</b> ${alamat}\n`
		pesan += `ğŸšš <b>Kurir:</b> ${kurir}\n\n`;
		pesan += `<b>ğŸ›ï¸ Daftar Produk:</b>\n`;

		cartSnap.forEach((docSnap, index) => {
		  const item = docSnap.data();
		  totalHarga += item.price * item.quantity;

		  pesan += `\n${index + 1}. <b>${item.name}</b>\nWarna: ${item.color || "-"}\nUkuran: ${item.size || "-"}\nQty: ${item.quantity}\nHarga: Rp ${item.price.toLocaleString('id-ID')}\n`;
		});

		pesan += `\n\n<b>ğŸ’° TOTAL: Rp ${totalHarga.toLocaleString('id-ID')}</b>`;

      const chat_id = "1903170022";
      const token = "5323538027:AAEKFXTpY40G1PKSrFsKzTDVeR4joDsXR9I";
      const url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chat_id}&text=${encodeURIComponent(pesan)}&parse_mode=html`;

      const response = await fetch(url);
      const result = await response.json();

      loading.style.display = 'none';

      if (result.ok) {
        success.style.display = 'block';
        await clearCart(user.uid); // ğŸ”¥ Clear cart setelah sukses
      } else {
        failed.style.display = 'block';
        console.error("âŒ Gagal kirim ke Telegram:", result.description);
      }

    } catch (error) {
      console.error("âŒ Error kirim pesanan:", error);
      loading.style.display = 'none';
      failed.style.display = 'block';
    }
  });
}

// ğŸ”¥ Clear semua cart item setelah order sukses
async function clearCart(uid) {
  const cartRef = collection(db, `carts/${uid}/items`);
  const cartSnap = await getDocs(cartRef);
  for (const docSnap of cartSnap.docs) {
    await deleteDoc(docSnap.ref);
  }
}

document.addEventListener("DOMContentLoaded", sendTelegramOrder);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
