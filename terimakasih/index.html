---
layout: compress
permalink: /success
---
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Terima Kasih - Pesanan Anda Terkonfirmasi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .spinner {
      width: 80px;
      height: 80px;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #0d6efd;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 30px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="d-flex flex-column justify-content-center align-items-center vh-100">

  <div id="statusBox" class="text-center">
    <div id="loading">
      <div class="spinner"></div>
      <h5>Mengirim konfirmasi ke admin...</h5>
    </div>
    <div id="success" style="display:none;">
      <h1 class="text-success mb-3">âœ… Terima Kasih!</h1>
      <p>Pesanan kamu berhasil dikirim ke admin.</p>
      <a href="/" class="btn btn-primary mt-3">Kembali ke Beranda</a>
    </div>
    <div id="failed" style="display:none;">
      <h1 class="text-danger mb-3">âŒ Gagal Kirim!</h1>
      <p>Mohon periksa koneksi atau hubungi admin manual.</p>
      <a href="/" class="btn btn-secondary mt-3">Coba Lagi</a>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, getDocs, getDoc, doc, collection, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "{{site.api_key}}",
  authDomain: "{{site.auth_domain}}",
  projectId: "{{site.project_id}}",
  storageBucket: "{{site.storage_bucket}}",
  messagingSenderId: "{{site.sender_id}}",
  appId: "{{site.app_id}}",
  measurementId: "{{site.measure_id}}"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Ambil order_id dari URL
const params = new URLSearchParams(window.location.search);
const orderId = params.get("order_id");

const loading = document.getElementById('loading');
const success = document.getElementById('success');
const failed = document.getElementById('failed');

onAuthStateChanged(auth, async (user) => {
  if (!user) return (window.location.href = "/userLogin");
  if (!orderId) return console.warn("âš ï¸ Tidak ada order_id di URL.");

  try {
    // ğŸ”¥ Update status ke 'paid'
    const orderRef = doc(db, "orders", orderId);
    await updateDoc(orderRef, {
      status: "paid",
      paidAt: new Date().toISOString()
    });

    console.log("âœ… Status pesanan diupdate ke 'paid'");

    // ğŸ”¥ Ambil info user
    const userSnap = await getDoc(doc(db, "users", user.uid));
    const buyer = userSnap.data();
    const fullName = `${buyer.firstName || ''} ${buyer.lastName || ''}`.trim();
    const alamat = `${buyer.address?.street || ''}, ${buyer.address?.city || ''}, ${buyer.address?.postalCode || ''}, ${buyer.address?.province || ''}, ${buyer.address?.country || ''}`;
    const kurir = `${buyer.shippingType || ''}`;

    // ğŸ”¥ Ambil cart
    const cartRef = collection(db, `carts/${user.uid}/items`);
    const cartSnap = await getDocs(cartRef);

    let total = 0;
    let pesan = `ğŸ›’ <b>Pesanan Baru Selesai Dibayar!</b>\n\n`;
    pesan += `ğŸ‘¤ <b>Nama:</b> ${fullName}\n`;
    pesan += `ğŸ“ <b>Telepon:</b> ${buyer.phone || '-' }\n`;
    pesan += `ğŸ  <b>Alamat:</b> ${alamat}\n`;
    pesan += `ğŸšš <b>Kurir:</b> ${kurir}\n\n`;
    pesan += `<b>ğŸ›ï¸ Daftar Produk:</b>\n`;

    cartSnap.forEach((docSnap, index) => {
      const item = docSnap.data();
      total += item.price * item.quantity;
      pesan += `\n#${index + 1}. <b>${item.name}</b>\n`;
      pesan += `Warna: ${item.color || '-'} | Ukuran: ${item.size || '-'}\n`;
      pesan += `Qty: ${item.quantity} x Rp ${item.price.toLocaleString('id-ID')}\n`;
    });

    pesan += `\nğŸ’° <b>Total:</b> Rp ${total.toLocaleString('id-ID')}`;

    // ğŸ”¥ Kirim Telegram
    const chat_id = "1903170022";
    const token = "5323538027:AAEKFXTpY40G1PKSrFsKzTDVeR4joDsXR9I";
    const url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chat_id}&text=${encodeURIComponent(pesan)}&parse_mode=html`;

    const response = await fetch(url);
    const result = await response.json();

    if (result.ok) {
      console.log("âœ… Pesan Telegram terkirim");
      success.style.display = 'block';
      loading.style.display = 'none';

      // ğŸ”¥ Clear cart
      for (const docSnap of cartSnap.docs) {
        await deleteDoc(docSnap.ref);
      }

    } else {
      console.error("âŒ Gagal kirim ke Telegram:", result.description);
      failed.style.display = 'block';
      loading.style.display = 'none';
    }

  } catch (error) {
    console.error("âŒ Gagal update order:", error);
    failed.style.display = 'block';
    loading.style.display = 'none';
  }
});
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
