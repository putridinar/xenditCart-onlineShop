---
layout: default
title: 
permalink: /product
xendit_options: test
---

<section class="product-detail py-2">
  <div class="container">
    <div id="productDetail" class="mt-5">
  <span class="text-center">{% include spiner.html %}</span>
    </div>
  </div>
</section>
<style>
.card img,
.img-fluid {
  border-radius: 1.5rem;
  transition: transform 0.4s ease;
}
.card img:hover {
  transform: scale(1.03);
}
.star-rate:hover {
  color: gold !important;
}
</style>

<script type="module" src="{{ '/assets/js/xenditCart.js' | relative_url }}"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, query, where, getDocs, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

// 🔥 Firebase Config
const firebaseConfig = {
  apiKey: "{{site.api_key}}",
  authDomain: "{{site.auth_domain}}",
  projectId: "{{site.project_id}}",
  storageBucket: "{{site.storage_bucket}}",
  messagingSenderId: "{{site.sender_id}}",
  appId: "{{site.app_id}}",
  measurementId: "{{site.measure_id}}"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Global State
let currentUser = null;
let importProduct = null;
let selectedOptions = { color: null, size: null };
let quantityInterval = null;

// 🔐 Cek Login
onAuthStateChanged(auth, (user) => {
  currentUser = user;
  if (user) checkLikedStatus();
});

// Ambil ID produk dari URL
const params = new URLSearchParams(window.location.search);
const id = params.get("id");
const container = document.getElementById("productDetail");

// 🔥 Load dan render produk
async function loadProduct() {
  if (!id) {
    container.innerHTML = "<p>Produk tidak ditemukan.</p>";
    return;
  }

  try {
    const docSnap = await getDoc(doc(db, "products", id));
    if (!docSnap.exists()) {
      container.innerHTML = "<p>Produk tidak ditemukan.</p>";
      return;
    }

    importProduct = docSnap.data();
    renderProductDetail(importProduct);
  } catch (error) {
    container.innerHTML = `<p>Gagal memuat produk: ${error.message}</p>`;
  }
}

// 🔥 Render Produk
function renderProductDetail(product) {
  const warnaButtons = product.colors?.map(color => `<button type="button" class="btn btn-outline-secondary color-btn" data-color="${color}">${color}</button>`).join('') || '';
  const ukuranButtons = product.sizes?.map(size => `<button type="button" class="btn btn-outline-secondary size-btn" data-size="${size}">${size}</button>`).join('') || '';

  container.innerHTML = `
    <div class="row g-5 align-items-start">
      <div class="col-md-6">
        <div class="position-relative shadow rounded-4 overflow-hidden">
          <img class="img-fluid w-100 object-fit-cover" style="max-height: 600px;" src="${product.image}" alt="${product.name}">
          <button class="btn btn-light position-absolute top-0 end-0 m-3 rounded-circle shadow-sm" id="likeButton">
            <i class="bi bi-heart fs-5"></i>
          </button>
        </div>
      </div>

      <div class="col-md-6">
        <h1 class="fw-bold mb-3">${product.name}</h1>

        <div class="d-flex align-items-center justify-content-between mb-3">
          <span class="h3 text-primary">Rp ${product.price.toLocaleString('id-ID')}</span>
          <div id="rating_form" class="d-flex align-items-center gap-1">
            ${[1, 2, 3, 4, 5].map(num => `<i class="bi bi-star text-muted fs-4 star-rate" data-star="${num}" style="cursor:pointer;"></i>`).join('')}
          </div>
        </div>
        <p id="ratingMessage" class="text-success mb-3 small"></p>
        <p class="text-muted lh-lg">${product.description || 'Deskripsi belum tersedia.'}</p>

        <hr class="my-4">

        <div class="mb-3">
          <h6 class="fw-semibold">Pilih Warna:</h6>
          <div id="colorOptions" class="d-flex flex-wrap gap-2">${warnaButtons}</div>
        </div>

        <div class="mb-3">
          <h6 class="fw-semibold">Pilih Ukuran:</h6>
          <div id="sizeOptions" class="d-flex flex-wrap gap-2">${ukuranButtons}</div>
        </div>

        <div class="mb-4">
          <h6 class="fw-semibold">Jumlah:</h6>
          <div class="d-flex align-items-center">
            <button class="btn btn-outline-secondary px-3" id="decreaseQty">−</button>
            <input type="text" id="quantityInput" class="form-control text-center mx-2" style="width: 70px;" value="1" readonly>
            <button class="btn btn-outline-secondary px-3" id="increaseQty">+</button>
          </div>
        </div>

        <div class="d-flex gap-3">
          <button id="buyNowButton" class="btn btn-success flex-grow-1 py-2 shadow-sm">🛒 Beli Sekarang</button>
          <button class="btn btn-outline-dark flex-grow-1 py-2 shadow-sm" id="addToCartButton">
            <i class="bi bi-bag-plus"></i> Tambah ke Keranjang
          </button>
        </div>
      </div>
    </div>
  `;

  setupInteractions();
  setupRatingEvents(); // ✅ Tempatkan di SINI setelah DOM sudah dirender
}

// ⭐ Event Bintang
function setupRatingEvents() {
  const rating_form = document.getElementById("rating_form");
  const ratingMessage = document.getElementById("ratingMessage");

  if (!rating_form) {
    console.warn("❌ Elemen rating_form tidak ditemukan!");
    return;
  }

  const voted = localStorage.getItem(`voted-${id}`);
  if (voted) {
    rating_form.style.pointerEvents = "none";
    ratingMessage.innerText = "✅ Anda sudah memberikan rating.";
    return;
  }

  document.querySelectorAll(".star-rate").forEach(star => {
    star.addEventListener("click", async () => {
      const ratingValue = parseInt(star.getAttribute("data-star"));
      try {
        const productRef = doc(db, "products", id);
        const productSnap = await getDoc(productRef);
        if (!productSnap.exists()) return;

        const data = productSnap.data();
        const newTotal = (data.ratingTotal || 0) + ratingValue;
        const newCount = (data.ratingCount || 0) + 1;

      await updateDoc(productRef, {
        ratingTotal: newTotal,
        ratingCount: newCount
      });

        localStorage.setItem(`voted-${id}`, "true");
        rating_form.style.pointerEvents = "none";
        ratingMessage.innerText = "✅ Terima kasih atas rating Anda!";
      } catch (err) {
        console.error("❌ Gagal kirim rating:", err);
      }
    });
  });
}

// 🔥 Setup Semua Interaksi
function setupInteractions() {
  document.querySelectorAll('.color-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedOptions.color = btn.getAttribute('data-color');
      document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  document.querySelectorAll('.size-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedOptions.size = btn.getAttribute('data-size');
      document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  const qtyInput = document.getElementById('quantityInput');
  document.getElementById('increaseQty').addEventListener('click', () => {
    if (parseInt(qtyInput.value) < importProduct.stock) {
      animateQuantity(qtyInput, parseInt(qtyInput.value) + 1);
    } else {
      showToast("Stok tidak cukup!", "warning");
    }
  });
  document.getElementById('decreaseQty').addEventListener('click', () => {
    if (parseInt(qtyInput.value) > 1) {
      animateQuantity(qtyInput, parseInt(qtyInput.value) - 1);
    }
  });

  document.getElementById('addToCartButton').addEventListener('click', () => {
    if (!selectedOptions.color || !selectedOptions.size) {
      showToast("Pilih warna dan ukuran dulu!", "warning");
      return;
    }
    addToCartFirestore({
      name: importProduct.name,
      price: importProduct.price,
      image: importProduct.image,
      color: selectedOptions.color,
      size: selectedOptions.size,
      quantity: parseInt(qtyInput.value)
    });
  });

  const likeButton = document.getElementById('likeButton');
  likeButton.addEventListener('click', toggleLikeProduct);
}


// 🔥 Animasi Quantity
function animateQuantity(input, newValue) {
  if (quantityInterval) clearInterval(quantityInterval);
  const step = newValue > parseInt(input.value) ? 1 : -1;
  quantityInterval = setInterval(() => {
    input.value = parseInt(input.value) + step;
    if (parseInt(input.value) === newValue) {
      clearInterval(quantityInterval);
      quantityInterval = null;
    }
  }, 50);
}

// 🔥 Add ke Cart Firestore
async function addToCartFirestore(item) {
  if (!currentUser) {
    showToast("Silakan login dulu untuk belanja!", "warning");
    setTimeout(() => window.location.href = "/userLogin", 800);
    return;
  }

  try {
    const cartRef = collection(db, `carts/${currentUser.uid}/items`);
    const q = query(cartRef, where("name", "==", item.name), where("color", "==", item.color), where("size", "==", item.size));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
      await addDoc(cartRef, item);
      showToast("✅ Produk ditambahkan ke keranjang!", "success");
    } else {
      snapshot.forEach(async docSnap => {
        await updateDoc(doc(db, `carts/${currentUser.uid}/items/${docSnap.id}`), {
          quantity: docSnap.data().quantity + item.quantity
        });
        showToast("✅ Jumlah produk di keranjang diperbarui!", "success");
      });
    }
  } catch (error) {
    console.error(error);
    showToast("Gagal tambah ke keranjang: " + error.message, "danger");
  }
}

// 🔥 Like / Unlike Produk
async function toggleLikeProduct() {
  if (!currentUser) {
    showToast("Silakan login untuk like produk ini!", "warning");
    return;
  }

  const likeRef = doc(db, `likes/${currentUser.uid}/products/${id}`);
  const likeSnap = await getDoc(likeRef);

  if (likeSnap.exists()) {
    await deleteDoc(likeRef);
    setLikedUI(false);
    showToast("Produk dihapus dari daftar suka", "warning");
  } else {
    await setDoc(likeRef, { liked: true });
    setLikedUI(true);
    showToast("Produk ditambahkan ke daftar suka", "success");
  }
}

// 🔥 Cek Apakah Produk Sudah Dilike
async function checkLikedStatus() {
  if (!currentUser) return;
  const likeRef = doc(db, `likes/${currentUser.uid}/products/${id}`);
  const likeSnap = await getDoc(likeRef);
  setLikedUI(likeSnap.exists());
}

// 🔥 Update UI Tombol Like
function setLikedUI(isLiked) {
  const likeButton = document.getElementById('likeButton');
  const icon = likeButton.querySelector('i');
  likeButton.classList.toggle('btn-outline-danger', isLiked);
  likeButton.classList.toggle('btn-danger', !isLiked);
  if (isLiked) {
    icon.classList.replace('bi-heart', 'bi-heart-fill');
  } else {
    icon.classList.replace('bi-heart-fill', 'bi-heart');
  }
}
console.log("🔍 Cek Elemen:", document.getElementById('rating_form'));

// 🚀 Mulai
loadProduct();
</script>

