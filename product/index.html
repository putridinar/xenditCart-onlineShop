---
layout: default
title: 
permalink: /product
---

<section class="product-detail py-2">
  <div class="container">
    <div id="productDetail" class="row g-3">
  <span class="text-center">Memuat detail produk...</span>
    </div>
  </div>
</section>

<script type="module" src="{{ '/assets/js/xenditCart.js' | relative_url }}"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, query, where, getDocs, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

// ðŸ”¥ Inisialisasi Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDN2dgu-Sdsc9K5fermxPFwDUiCzX71ce8",
  authDomain: "tokoputridinar.firebaseapp.com",
  projectId: "tokoputridinar",
  storageBucket: "tokoputridinar.firebasestorage.app",
  messagingSenderId: "747234240117",
  appId: "1:747234240117:web:a87af4f6724ab87ad23a3c",
  measurementId: "G-M2JGJH3NVQ"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
onAuthStateChanged(auth, (user) => {
  currentUser = user;
  if (user) checkLikedStatus();
});

const params = new URLSearchParams(window.location.search);
const id = params.get("id");
const container = document.getElementById("productDetail");

let importProduct = null;
let selectedOptions = { color: null, size: null };
let quantityInterval = null;

// ðŸ”¥ Load Produk dari Firestore
async function loadProduct() {
  if (!id) {
    container.innerHTML = "<p>Produk tidak ditemukan.</p>";
    return;
  }

  try {
    const docSnap = await getDoc(doc(db, "products", id));
    if (!docSnap.exists()) {
      container.innerHTML = "<p>Produk tidak ditemukan.</p>";
      return;
    }

    importProduct = docSnap.data();
    renderProductDetail(importProduct);
    setupInteractions();
  } catch (error) {
    container.innerHTML = `<p>Gagal memuat produk: ${error.message}</p>`;
  }
}

// ðŸ”¥ Render Produk ke HTML
function renderProductDetail(product) {
  let warnaButtons = product.colors?.map(color => `<button type="button" class="btn btn-outline-secondary color-btn" data-color="${color}">${color}</button>`).join('') || '';
  let ukuranButtons = product.sizes?.map(size => `<button type="button" class="btn btn-outline-secondary size-btn" data-size="${size}">${size}</button>`).join('') || '';

  container.innerHTML = `
    <div class="col-md-6">
      <img class="img-fluid rounded shadow-sm" src="${product.image}" alt="${product.name}" style="width:100vw;">
    </div>
    <div class="col-md-6">
      <h2 class="mb-3">${product.name}</h2>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="h4 mb-0 text-primary">Rp ${product.price.toLocaleString('id-ID')}</span>
        <button class="btn btn-outline-danger btn-like" id="likeButton">
          <i class="bi bi-heart"></i> <span>Like</span>
        </button>
      </div>
      <p class="text-muted">${product.description || ''}</p>
      <div class="mb-4"><h6>Pilih Warna:</h6><div id="colorOptions" class="d-flex gap-2">${warnaButtons}</div></div>
      <div class="mb-4"><h6>Pilih Ukuran:</h6><div id="sizeOptions" class="d-flex gap-2">${ukuranButtons}</div></div>
      <div class="mb-4">
        <h6>Jumlah:</h6>
        <div class="d-flex">
          <button class="btn btn-outline-secondary" id="decreaseQty">-</button>
          <input type="text" id="quantityInput" class="form-control text-center mx-2" value="1" style="width: 60px;" readonly>
          <button class="btn btn-outline-secondary" id="increaseQty">+</button>
        </div>
      </div>
		<div class="row-space">
		  <button class="btn btn-success">Beli Sekarang</button>
		  
		  <button class="btn btn-primary" id="addToCartButton">Tambah ke Keranjang</button>
		</div>
    </div>`;
}

// ðŸ”¥ Setup Semua Interaksi
function setupInteractions() {
  document.querySelectorAll('.color-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedOptions.color = btn.getAttribute('data-color');
      document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  document.querySelectorAll('.size-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedOptions.size = btn.getAttribute('data-size');
      document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  const qtyInput = document.getElementById('quantityInput');
  document.getElementById('increaseQty').addEventListener('click', () => {
    if (parseInt(qtyInput.value) < importProduct.stock) {
      animateQuantity(qtyInput, parseInt(qtyInput.value) + 1);
    } else {
      showToast("Stok tidak cukup!", "warning");
    }
  });
  document.getElementById('decreaseQty').addEventListener('click', () => {
    if (parseInt(qtyInput.value) > 1) {
      animateQuantity(qtyInput, parseInt(qtyInput.value) - 1);
    }
  });

  document.getElementById('addToCartButton').addEventListener('click', () => {
    if (!selectedOptions.color || !selectedOptions.size) {
      showToast("Pilih warna dan ukuran dulu!", "warning");
      return;
    }
    addToCartFirestore({
      name: importProduct.name,
      price: importProduct.price,
      image: importProduct.image,
      color: selectedOptions.color,
      size: selectedOptions.size,
      quantity: parseInt(qtyInput.value)
    });
  });

  const likeButton = document.getElementById('likeButton');
  likeButton.addEventListener('click', toggleLikeProduct);
}

// ðŸ”¥ Animasi Quantity
function animateQuantity(input, newValue) {
  if (quantityInterval) clearInterval(quantityInterval);
  const step = newValue > parseInt(input.value) ? 1 : -1;
  quantityInterval = setInterval(() => {
    input.value = parseInt(input.value) + step;
    if (parseInt(input.value) === newValue) {
      clearInterval(quantityInterval);
      quantityInterval = null;
    }
  }, 50);
}

// ðŸ”¥ Add ke Cart Firestore
async function addToCartFirestore(item) {
  if (!currentUser) {
    showToast("Silakan login dulu untuk belanja!", "warning");
    setTimeout(() => window.location.href = "/userLogin", 800);
    return;
  }

  try {
    const cartRef = collection(db, `carts/${currentUser.uid}/items`);
    const q = query(cartRef, where("name", "==", item.name), where("color", "==", item.color), where("size", "==", item.size));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
      await addDoc(cartRef, item);
      showToast("âœ… Produk ditambahkan ke keranjang!", "success");
    } else {
      snapshot.forEach(async docSnap => {
        await updateDoc(doc(db, `carts/${currentUser.uid}/items/${docSnap.id}`), {
          quantity: docSnap.data().quantity + item.quantity
        });
        showToast("âœ… Jumlah produk di keranjang diperbarui!", "success");
      });
    }
  } catch (error) {
    console.error(error);
    showToast("Gagal tambah ke keranjang: " + error.message, "danger");
  }
}

// ðŸ”¥ Like / Unlike Produk
async function toggleLikeProduct() {
  if (!currentUser) {
    showToast("Silakan login untuk like produk ini!", "warning");
    return;
  }

  const likeRef = doc(db, `likes/${currentUser.uid}/products/${id}`);
  const likeSnap = await getDoc(likeRef);

  if (likeSnap.exists()) {
    await deleteDoc(likeRef);
    setLikedUI(false);
    showToast("Produk dihapus dari daftar suka", "warning");
  } else {
    await setDoc(likeRef, { liked: true });
    setLikedUI(true);
    showToast("Produk ditambahkan ke daftar suka", "success");
  }
}

// ðŸ”¥ Cek Apakah Produk Sudah Dilike
async function checkLikedStatus() {
  if (!currentUser) return;
  const likeRef = doc(db, `likes/${currentUser.uid}/products/${id}`);
  const likeSnap = await getDoc(likeRef);
  setLikedUI(likeSnap.exists());
}

// ðŸ”¥ Update UI Tombol Like
function setLikedUI(isLiked) {
  const likeButton = document.getElementById('likeButton');
  const icon = likeButton.querySelector('i');
  likeButton.classList.toggle('btn-danger', isLiked);
  likeButton.classList.toggle('btn-outline-danger', !isLiked);
  if (isLiked) {
    icon.classList.replace('bi-heart', 'bi-heart-fill');
  } else {
    icon.classList.replace('bi-heart-fill', 'bi-heart');
  }
}

// ðŸš€ Mulai
loadProduct();
</script>

